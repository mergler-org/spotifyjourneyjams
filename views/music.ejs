<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Spotify Journey Jams</title>
    <link href="./output.css" rel="stylesheet" />
</head>

<body class="flex h-screen items-center">
    <div class="m-auto bg-blue-500 max-w-2xl mx-auto p-8">
        <h1 class="text-3xl font-bold text-white mb-4">Spotify Journey Jams</h1>
        <h2 class="text-lg text-white mb-4" id="travels"></h2>
        <form id="searchForm" class="bg-red-400 p-5">
            <div class="mb-4">
                <label class="block text-white text-sm font-semibold mb-2">Search by:</label>
                <div class="flex items-center">
                    <label for="searchByArtist" class="mr-2">
                        <input type="radio" id="searchByArtist" name="searchType" value="artist" class="mr-1" checked />
                        Artist
                    </label>
                    <label for="searchBySong">
                        <input type="radio" id="searchBySong" name="searchType" value="song" class="mr-1" />
                        Song
                    </label>
                </div>
            </div>
            <div class="mb-4">
                <label for="searchTerm" class="block text-white text-sm font-semibold mb-2">Search Term:</label>
                <input type="text" id="searchTerm" name="searchTerm" placeholder="Enter search term"
                    class="bg-white text-gray-800 w-full p-2" required />
            </div>
            <div class="mb-4">
                <label for="creativitySlider" class="block text-white text-sm font-semibold mb-2">Creativity:</label>
                <input type="range" id="creativitySlider" name="creativity" min="0" max="10" value="5" class="w-full" />
            </div>
        </form>
        <button id="submit" type="button" onclick="submitForm()" class="bg-green-600 text-white p-2 cursor-pointer">
            Search Jams
        </button>
        <div id="result" class="mt-4"></div>
    </div>
</body>
<script>
    let initialSearchType, initialSearchTerm, initialCreativity, offset;

    async function submitForm() {
        const creativity = document.getElementById("creativitySlider").value;
        const searchType = document.getElementById("searchByArtist").checked
            ? "artist"
            : "song";
        const searchTerm = document.getElementById("searchTerm").value;

        console.log("Submitting form with:", searchType, searchTerm, creativity);

        offset = 0

        // Compare with initial values and return if no changes
        if (
            searchType === initialSearchType &&
            searchTerm === initialSearchTerm &&
            creativity === initialCreativity
        ) {
            console.log("Form values unchanged. Aborting form submission.");
            return;
        }


        const response = await fetch("/search", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ searchType, searchTerm, creativity, offset }),
        });
        // Update initial values only after a successful submission
        initialCreativity = creativity;
        initialSearchTerm = searchTerm;
        initialSearchType = searchType;

        if (response.ok) {
            const data = await response.json();
            console.log("Received data from server:", data);

            updateResult(data);
        } else {
            console.error("Error submitting form:", response.statusText);
        }
    }

    function formatDuration(duration) {
        const hours = Math.floor(duration / 3600);
        const minutes = Math.floor((duration % 3600) / 60);

        if (hours < 1) {
            return `${minutes} minutes`;
        } else {
            return `${hours} hours and ${minutes} minutes`;
        }
    }

    function formatDistance(distance) {
        return (distance * 0.000621371).toFixed(1);
    }

    let selection = null; // Variable to store the selected URI
    function updateResult(data) {
        results = document.getElementById("result");
        response = data.search;
        let search = "<table class='border border-collapse'>";

        if (initialSearchType == "artist") {
            for (let i in response) {
                const name = response[i].name;
                const imageUrl = response[i].images.length > 0 ? response[i].images[response[i].images.length - 1].url : "https://developer.spotify.com/images/guidelines/design/icon4@2x.png";
                const genres = response[i].genres.length > 0 ? response[i].genres.slice(0, 3).join(", ") : "";
                const URL = response[i].external_urls.spotify;
                const URI = response[i].id;

                // Use URI as the id of the row
                search += "<tr id='" + URI + "' class='hover:bg-sky-700 cursor-pointer p-10' onclick='handleRowClick(this)'><td><a target='_blank' href='" + URL + "'>" +
                    "<div class='p-2'><img src='" + imageUrl + "' class='h-16 w-16 object-cover rounded' alt='" + name + "'></div></a></td>" +
                    "<td><div class='p-2'>" + name + "</div></td><td><div class='p-2'>" + genres + "</div></td></tr> ";
            }
        }

        search += '</table><button id="submit" type="button" onclick="nextPage()" class="bg-green-200 text-black p-2 cursor-pointer" > next </button>';
        results.innerHTML = search;
    }

    async function nextPage() {
        offset += 10

        console.log("Fetching next page with offset", offset);
        const response = await fetch("/search", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                searchType: initialSearchType,
                searchTerm: initialSearchTerm,
                creativity: initialCreativity,
                offset: offset,  // Set the offset to 10 for the next page
            }),
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Received data from server:", data);

            updateResult(data);
        } else {
            console.error("Error fetching next page:", response.statusText);
        }
    }


    function handleRowClick(row) {
        // Clear previous selection if any
        const whenHighlighted = "border-4 border-black";

        if (selection) {
            const previousSelectionRow = document.getElementById(selection);
            // Split the class names and remove them one by one
            whenHighlighted.split(' ').forEach(className => {
                previousSelectionRow.classList.remove(className);
            });
        }

        // Set the new selection
        selection = row.id;

        // Highlight the selected row
        whenHighlighted.split(' ').forEach(className => {
            row.classList.add(className);
        });
    }



    document.getElementById("travels").innerHTML = (formatDistance(<%=distance %>) + " miles    " + formatDuration(<%=duration %>))
</script>

</html>